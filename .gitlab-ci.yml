# GitLab Dependency Proxy to get rid of Docker hub pull limit issue
# https://docs.gitlab.com/ee/user/packages/dependency_proxy/#authenticate-within-cicd
image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/node:14.17.3

before_script:
  # upgrade npm
  - npm install -g npm@7.11.1
  - npm -v
  - npm install

stages:
  - test
  - build

variables:
  # This fixes "error during connect: Post http://docker:2375/v1.40/auth: dial tcp: lookup docker on 192.168.65.5:53: no such host"
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2
  # See https://github.com/docker-library/docker/pull/166
  DOCKER_TLS_CERTDIR: ""

## Test

lint:
  stage: test
  script:
    - npm run lint

test:
  stage: test
  script:
    - npm test

## Build

build:
  stage: build
  needs: ["test"]
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/docker:19.03.12
  services:
    - name: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/docker:19.03.12-dind
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    # fix: "Browserslist: caniuse-lite is outdated"
    - npx browserslist@latest --update-db
    - npm run build
    # push to gitlab
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
